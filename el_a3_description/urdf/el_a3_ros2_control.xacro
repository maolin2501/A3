<?xml version="1.0"?>
<!-- EL-A3 ros2_control configuration -->
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:macro name="el_a3_ros2_control" params="use_mock_hardware can_interface host_can_id">

    <ros2_control name="RsA3System" type="system">
      <hardware>
        <xacro:if value="${use_mock_hardware}">
          <plugin>mock_components/GenericSystem</plugin>
          <param name="mock_sensor_commands">false</param>
        </xacro:if>
        <xacro:unless value="${use_mock_hardware}">
          <plugin>el_a3_hardware/RsA3HardwareInterface</plugin>
          <param name="can_interface">${can_interface}</param>
          <param name="host_can_id">${host_can_id}</param>
          <param name="position_kp">80.0</param>
          <param name="position_kd">4.0</param>
          <param name="velocity_limit">10.0</param>
          <!-- S-curve trajectory planning parameters -->
          <param name="s_curve_enabled">false</param>   <!-- Temporarily disabled to avoid conflict with MoveIt trajectory -->
          <param name="max_velocity">3.0</param>        <!-- Max velocity limit rad/s -->
          <param name="max_acceleration">15.0</param>   <!-- Max acceleration limit rad/s² -->
          <param name="max_jerk">50.0</param>           <!-- Max jerk limit rad/s³ -->
          <!-- Fallback smoothing filter parameters (used when S-curve is disabled) -->
          <param name="smoothing_alpha">0.2</param>     <!-- Low-pass filter coefficient -->
          
          <!-- Gravity compensation feedforward parameters (50% gravity as feedforward torque) -->
          <param name="gravity_feedforward_ratio">0.5</param>  <!-- 50% gravity compensation ratio -->
          
          <!-- Zero-torque mode parameters -->
          <param name="zero_torque_kd">0.3</param>  <!-- Zero-torque mode damping coefficient -->
          
          <!-- Pinocchio dynamics model configuration -->
          <!-- Note: Requires absolute path to URDF file -->
          <param name="urdf_path">/home/wy/RS/A3/el_a3_description/urdf/el_a3.urdf</param>
          <param name="use_pinocchio_gravity">true</param>  <!-- Enable full dynamics gravity compensation -->
          
          <!-- Inertia parameter config file path (generated by inertia_calibration.py) -->
          <param name="inertia_config_path">/home/wy/RS/A3/el_a3_description/config/inertia_params.yaml</param>
          
          <!-- Inertia parameter scale factors (legacy method, kept for backward compatibility) -->
          <param name="inertia_scale_L1_mass">1.0000</param>
          <param name="inertia_scale_L2_mass">2.0000</param>
          <param name="inertia_scale_L3_mass">0.6839</param>
          <param name="inertia_scale_L4_mass">0.3500</param>
          <param name="inertia_scale_L5_mass">1.0000</param>
          <param name="inertia_scale_L6_mass">1.0000</param>
          
          <!-- L1 joint - Base rotation around Z-axis, no gravity effect -->
          <param name="gravity_comp_L1_sin">0.0</param>
          <param name="gravity_comp_L1_cos">0.0</param>
          <param name="gravity_comp_L1_offset">0.0</param>
          
          <!-- L2 joint - Upper arm pitch, bears primary gravity load -->
          <!-- τ = m*g*L*sin(θ), needs calibration based on actual measurements -->
          <param name="gravity_comp_L2_sin">3.5</param>
          <param name="gravity_comp_L2_cos">0.0</param>
          <param name="gravity_comp_L2_offset">0.0</param>
          
          <!-- L3 joint - Forearm pitch -->
          <param name="gravity_comp_L3_sin">2.0</param>
          <param name="gravity_comp_L3_cos">0.0</param>
          <param name="gravity_comp_L3_offset">0.0</param>
          
          <!-- L4 joint - Wrist Roll -->
          <param name="gravity_comp_L4_sin">0.0</param>
          <param name="gravity_comp_L4_cos">0.0</param>
          <param name="gravity_comp_L4_offset">0.0</param>
          
          <!-- L5 joint - Wrist Pitch -->
          <param name="gravity_comp_L5_sin">0.3</param>
          <param name="gravity_comp_L5_cos">0.0</param>
          <param name="gravity_comp_L5_offset">0.0</param>
          
          <!-- L6 joint - Wrist Yaw -->
          <param name="gravity_comp_L6_sin">0.0</param>
          <param name="gravity_comp_L6_cos">0.0</param>
          <param name="gravity_comp_L6_offset">0.0</param>
        </xacro:unless>
      </hardware>

      <!-- Joint L1 - RS00 Motor 1 -->
      <joint name="L1_joint">
        <param name="motor_id">1</param>
        <param name="motor_type">RS00</param>
        <param name="position_offset">0.0</param>
        <param name="direction">-1.0</param>
        <command_interface name="position">
          <param name="min">-2.79253</param>
          <param name="max">2.79253</param>
        </command_interface>
        <command_interface name="velocity">
          <param name="min">-33.0</param>
          <param name="max">33.0</param>
        </command_interface>
        <command_interface name="effort">
          <param name="min">-14.0</param>
          <param name="max">14.0</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
      </joint>

      <!-- Joint L2 - RS00 Motor 2 -->
      <joint name="L2_joint">
        <param name="motor_id">2</param>
        <param name="motor_type">RS00</param>
        <param name="position_offset">0.0</param>
        <param name="direction">1.0</param>
        <command_interface name="position">
          <param name="min">0</param>
          <param name="max">3.66519</param>
        </command_interface>
        <command_interface name="velocity">
          <param name="min">-33.0</param>
          <param name="max">33.0</param>
        </command_interface>
        <command_interface name="effort">
          <param name="min">-14.0</param>
          <param name="max">14.0</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
      </joint>

      <!-- Joint L3 - RS00 Motor 3 -->
      <joint name="L3_joint">
        <param name="motor_id">3</param>
        <param name="motor_type">RS00</param>
        <param name="position_offset">0.0</param>
        <param name="direction">-1.0</param>
        <command_interface name="position">
          <param name="min">-4.01426</param>
          <param name="max">0</param>
        </command_interface>
        <command_interface name="velocity">
          <param name="min">-33.0</param>
          <param name="max">33.0</param>
        </command_interface>
        <command_interface name="effort">
          <param name="min">-14.0</param>
          <param name="max">14.0</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
      </joint>

      <!-- Joint L4 - EL05 Motor 4 -->
      <joint name="L4_joint">
        <param name="motor_id">4</param>
        <param name="motor_type">EL05</param>
        <param name="position_offset">0.0</param>
        <param name="direction">1.0</param>
        <command_interface name="position">
          <param name="min">-1.5708</param>
          <param name="max">1.5708</param>
        </command_interface>
        <command_interface name="velocity">
          <param name="min">-50.0</param>
          <param name="max">50.0</param>
        </command_interface>
        <command_interface name="effort">
          <param name="min">-6.0</param>
          <param name="max">6.0</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
      </joint>

      <!-- Joint L5 - EL05 Motor 5 -->
      <joint name="L5_joint">
        <param name="motor_id">5</param>
        <param name="motor_type">EL05</param>
        <param name="position_offset">0.0</param>
        <param name="direction">-1.0</param>
        <command_interface name="position">
          <param name="min">-1.5708</param>
          <param name="max">1.5708</param>
        </command_interface>
        <command_interface name="velocity">
          <param name="min">-50.0</param>
          <param name="max">50.0</param>
        </command_interface>
        <command_interface name="effort">
          <param name="min">-6.0</param>
          <param name="max">6.0</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
      </joint>

      <!-- Joint L6 - EL05 Motor 6 -->
      <joint name="L6_joint">
        <param name="motor_id">6</param>
        <param name="motor_type">EL05</param>
        <param name="position_offset">0.0</param>
        <param name="direction">1.0</param>
        <command_interface name="position">
          <param name="min">-1.5708</param>
          <param name="max">1.5708</param>
        </command_interface>
        <command_interface name="velocity">
          <param name="min">-50.0</param>
          <param name="max">50.0</param>
        </command_interface>
        <command_interface name="effort">
          <param name="min">-6.0</param>
          <param name="max">6.0</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
      </joint>

    </ros2_control>

  </xacro:macro>

</robot>
